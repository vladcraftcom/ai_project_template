# Архитектура проекта

Техническое описание архитектуры AI Project Template.

## 📑 Содержание

1. [Обзор архитектуры](#обзор-архитектуры)
2. [Компоненты системы](#компоненты-системы)
3. [Паттерны проектирования](#паттерны-проектирования)
4. [Потоки данных](#потоки-данных)
5. [Зависимости](#зависимости)

## 🏗️ Обзор архитектуры

AI Project Template использует **архитектуру Model-View-Update (MVU)**, реализованную через фреймворк [Iced](https://github.com/iced-rs/iced).

### Принципы

- **Разделение ответственности**: UI отделен от бизнес-логики
- **Явное управление состоянием**: Все изменения состояния происходят через сообщения
- **Асинхронность**: Долгие операции (загрузка пресетов, создание проектов) выполняются асинхронно
- **Кроссплатформенность**: Единый код для Windows, macOS и Linux

### Диаграмма компонентов

```
┌─────────────────────────────────────────┐
│           Iced GUI Framework            │
│  ┌───────────────────────────────────┐  │
│  │        AppState (Model)           │  │
│  │  - presets_dir                    │  │
│  │  - available_presets              │  │
│  │  - selected_preset                │  │
│  │  - preset_config                  │  │
│  │  - project_name                    │  │
│  │  - dynamic_fields/options          │  │
│  └───────────────────────────────────┘  │
│           ↕ Messages                     │
│  ┌───────────────────────────────────┐  │
│  │      Update Handler (Control)      │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
           ↕
┌─────────────────────────────────────────┐
│         Business Logic Modules          │
│  ┌──────────────┐  ┌──────────────┐     │
│  │   presets    │  │   command    │     │
│  │   module     │  │   module     │     │
│  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────┘
           ↕
┌─────────────────────────────────────────┐
│        External Dependencies            │
│  - GitHub (HTTP)                        │
│  - File System                          │
│  - OS Notifications                     │
└─────────────────────────────────────────┘
```

## 🧩 Компоненты системы

### Модуль `main.rs`

**Ответственность**: UI, состояние приложения, обработка событий

**Основные структуры:**

- **`AppState`**: Состояние приложения
  - Хранит все данные UI
  - Управляет пресетами и конфигурациями
  - Управляет состоянием создания проекта
  
- **`Msg`**: Сообщения (команды) для обновления состояния
  - События пользователя (клики, ввод текста)
  - Результаты асинхронных операций
  - События таймера

**Основные методы:**

- `new()`: Инициализация приложения, загрузка пресетов
- `update()`: Обработка сообщений и обновление состояния
- `view()`: Построение UI на основе текущего состояния
- `subscription()`: Подписка на периодические события

### Модуль `presets.rs`

**Ответственность**: Управление пресетами и их конфигурациями

**Основные функции:**

- `discover_presets()`: Найти все доступные пресеты в директории
- `load_preset_config()`: Загрузить конфигурацию пресета из JSON
- `download_and_extract_presets()`: Скачать и распаковать пресеты из GitHub
- `save_presets_path_to_global_namespace()`: Сохранить путь к пресетам в ОС
- `load_presets_path_from_global_namespace()`: Загрузить путь к пресетам из ОС

**Основные структуры:**

- `PresetConfig`: Конфигурация пресета
- `TemplateConfig`: Конфигурация шаблона файла
- `FieldConfig`: Конфигурация динамического поля
- `OptionConfig`: Конфигурация опции

### Модуль `command.rs`

**Ответственность**: Создание проектов на основе конфигурации пресета

**Основные функции:**

- `create_project()`: Главная функция создания проекта
  - Создает директории
  - Копирует шаблоны
  - Создает пустые файлы
  - Генерирует README.md

## 🎨 Паттерны проектирования

### Model-View-Update (MVU)

Приложение следует паттерну MVU:

1. **Model (Модель)**: `AppState` - хранит все состояние приложения
2. **View (Представление)**: `view()` - строит UI на основе модели
3. **Update (Обновление)**: `update()` - обрабатывает сообщения и обновляет модель

**Преимущества:**
- Предсказуемое управление состоянием
- Легкое тестирование логики
- Отсутствие побочных эффектов в UI коде

### Command Pattern

Асинхронные операции выполняются через `Command`:

```rust
Command::perform(async move {
    // Асинхронная операция
}, |result| Msg::OperationCompleted(result))
```

**Преимущества:**
- Разделение синхронного UI и асинхронной логики
- Возможность отмены операций
- Изоляция ошибок

### Strategy Pattern

Различные пресеты представляют различные стратегии создания проектов:

- Каждый пресет определяет свою структуру проекта
- Общая функция `create_project()` применяет стратегию из конфигурации
- Новые стратегии добавляются через новые пресеты

## 🔄 Потоки данных

### Инициализация приложения

```
1. AppState::new()
   ↓
2. load_presets_path_from_global_namespace()
   ↓
3a. Путь найден → discover_presets()
3b. Путь не найден → показать диалог выбора папки
   ↓
4. download_and_extract_presets() (если путь не найден)
   ↓
5. discover_presets()
   ↓
6. Автоматически выбрать первый пресет
   ↓
7. load_preset_config()
```

### Создание проекта

```
1. Пользователь нажимает "Create project"
   ↓
2. Msg::Create → update()
   ↓
3. Проверка can_create()
   ↓
4. Command::perform(create_project())
   ↓
5. create_project() выполняет:
   - Создание директорий
   - Копирование шаблонов
   - Создание пустых файлов
   - Генерация README.md
   ↓
6. Msg::ProcessFinished
   ↓
7. Отправка системного уведомления
```

### Обновление пресетов

```
1. Пользователь нажимает "Refresh Presets"
   ↓
2. Msg::RefreshPresets → update()
   ↓
3. Command::perform(download_and_extract_presets())
   ↓
4. download_and_extract_presets():
   - Скачивание ZIP из GitHub
   - Распаковка в целевую директорию
   - Сохранение существующих кастомных пресетов
   ↓
5. Msg::PresetsDownloaded
   ↓
6. discover_presets()
   ↓
7. Msg::PresetsLoaded
   ↓
8. Обновление списка пресетов в UI
```

## 📦 Зависимости

### Основные зависимости

- **`iced`** (v0.12): GUI фреймворк с поддержкой MVU и асинхронности
- **`tokio`**: Асинхронный runtime для выполнения долгих операций
- **`serde` / `serde_json`**: Сериализация/десериализация JSON конфигураций
- **`reqwest`**: HTTP клиент для загрузки пресетов из GitHub
- **`zip`**: Работа с ZIP архивами
- **`notify-rust`**: Кроссплатформенные системные уведомления
- **`rfd`**: Кроссплатформенные диалоги выбора файлов/папок
- **`regex`**: Валидация имени проекта
- **`chrono`**: Форматирование даты и времени
- **`directories`**: Определение стандартных путей в ОС

### Платформо-специфичные особенности

- **Windows**: Использует `setx` для сохранения переменных окружения
- **macOS**: Использует Notification Center для уведомлений
- **Linux**: Использует DBus для уведомлений (требует сервер уведомлений)
- **Unix**: Сохраняет права доступа файлов при распаковке ZIP

## 🔐 Управление состоянием

### Состояние приложения (`AppState`)

Все состояние приложения хранится в одной структуре `AppState`:

```rust
struct AppState {
    // Пресеты
    presets_dir: Option<PathBuf>,
    available_presets: Vec<String>,
    selected_preset: Option<String>,
    preset_config: Option<PresetConfig>,
    dynamic_fields: HashMap<String, String>,
    dynamic_options: HashMap<String, bool>,
    
    // Проект
    project_name: String,
    
    // UI состояние
    project_name_error: String,
    is_busy: bool,
    log_lines: Vec<String>,
    show_dialog: bool,
    dialog_progress: f32,
    // ...
}
```

### Иммутабельные обновления

Все изменения состояния происходят через функцию `update()`, которая возвращает новое состояние. Это обеспечивает:

- Предсказуемость изменений
- Возможность отладки через логирование сообщений
- Легкость тестирования

## 🌐 Асинхронность

### Tokio Runtime

Приложение использует Tokio для асинхронных операций:

- Загрузка пресетов из GitHub
- Распаковка ZIP архивов
- Создание проектов (файловые операции)

### Command Pattern

Асинхронные операции инкапсулированы в `Command`:

```rust
Command::perform(async move {
    // Асинхронная операция
    download_and_extract_presets(&dir, url).await
}, |result| {
    // Обработка результата
    Msg::OperationCompleted(result)
})
```

Это позволяет UI оставаться отзывчивым во время долгих операций.

## 📁 Организация файлов

```
ai_project_template/
├── src/
│   ├── main.rs          # UI и основная логика приложения
│   ├── presets.rs       # Модуль управления пресетами
│   └── command.rs       # Модуль создания проектов
├── docs/                # Документация (эта папка)
├── Cargo.toml           # Зависимости и метаданные проекта
└── README.md            # Основной README
```

---

*Следующие разделы: [API Документация](API.md) | [Руководство разработчика](DEVELOPMENT.md)*

