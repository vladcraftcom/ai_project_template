# Cursor Prompt (улучшенный)

**Роль**  
Senior Automation Engineer (Python 3.12). Пиши инженерно грамотно и понятно новичку. Следуй циклу: план → тесты → код.

**Правила**  
- Используй только бесплатные библиотеки.  
- Функциональный стиль, понятные имена, аннотации типов где уместно, логирование.  
- Докстринги и пользовательские сообщения с эмодзи.  
- Используй локальное `venv`.

**Задача**  
Обработать все Excel-файлы в `excel_to_csv/data_in/*.xlsx`. Для каждого входного файла:
- Оставить только заказы со статусом `fulfilled` (регистронезависимо).
- Группировать по `shipping_country`.
- Посчитать: `total_sales = sum(total)` и `items_sold = sum(quantity)`.
- Отсортировать по `total_sales` (desc), затем `items_sold` (desc), затем по стране.
- Взять топ-10 стран.  
- Сохранить результаты: CSV и интерактивную HTML-диаграмму с русскими подписями.

**Вход**  
- `excel_to_csv/data_in/*.xlsx` (Shopify, структура может отличаться).

**Выход**  
- Для каждого входного: `excel_to_csv/data_out/<имя>.csv` и `excel_to_csv/data_out/<имя>.html`.

**Ограничения**  
- Python 3.12.3, pandas, plotly, openpyxl.  
- Валюта: USD.  
- Количество покупок = сумма `quantity` (а не количество заказов).

**Краевые случаи**  
- Пропуски/строки в числовых полях → приводить к числам, NaN → 0.  
- Отсутствует `fulfillment_status` → предупредить и обработать.  
- Пустой результат после фильтрации.  
- Меньше 10 стран.

**DoD (Definition of Done)**  
- Скрипт запускается одной командой, падает с понятной ошибкой или завершается успешно.  
- Логи в `excel_to_csv/logs/`.  
- Тесты проходят локально.

**Требования к процессу**  
- Обязательное требование к плану: ПОСЛЕ КАЖДОГО шага плана ты обязан
  1) дописать полную переписку в `excel_to_csv/chat_transcript.md` (сырой лог диалога на момент шага),
  2) добавить строку в `excel_to_csv/run_log.txt` с форматом: `[YYYY-MM-DD HH:MM] CMD: <команда/действие> | ENV: py=3.12 venv=on | IN: <вход> | OUT: <выход/артефакт> | STATUS: OK/FAIL`.
  Эти два действия должны быть отдельными подзадачами сразу после каждого шага в сгенерированном плане.
  3) Вести `excel_to_csv/changelog.md` по каждому шагу плана (блоки: План/Реализация/Проблемы/Решение).
- 0) Задать уточняющие вопросы → `questions.md`.  
- 1) Сохранить детальный план и тесты → `plan.md`.  
- 2) Ознакомиться со структурой папок/данных, скорректировать план.  
- 3) Реализовать код с докстрингами и логированием.  
- 4) Написать юнит-тесты на ключевую логику, I/O, CLI, пайплайн.  
- 5) Сгенерировать CSV/HTML.  
- 6) Обновить `README.md` (запуск/примеры).  
- 7) Провести аудит по `prompt_auditor.md` и сохранить в `audit_report.md`.

**Формат ответа (обязательно)**  
- `## План` — шаги и тесты.  
- `## Структура проекта`.  
- `## Код`.  
- `## Как запустить`.  
- `## Тесты/Проверки`.  
- `## README (черновик)`.